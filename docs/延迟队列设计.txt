ğŸ“š ç»Ÿä¸€å»¶è¿Ÿæ¶ˆæ¯ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆAI å¯è¯» & å¯æ‰§è¡Œæ–‡æ¡£ï¼‰
æœ¬æ–¹æ¡ˆæ—¨åœ¨ä¸ºæ‰€æœ‰ä¸»æµæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRocketMQã€RabbitMQã€Kafkaã€ActiveMQ ç­‰ï¼‰æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å»¶è¿Ÿæ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œæ”¯æŒä»»æ„æ—¶é—´å»¶è¿Ÿã€é«˜å¯ç”¨ã€å¯æ‰©å±•ï¼Œå¹¶é€‚ç”¨äº AI è‡ªåŠ¨åŒ–ç†è§£ä¸éƒ¨åˆ†ä»£ç ç”Ÿæˆã€‚

âœ… è®¾è®¡ç›®æ ‡
ç›®æ ‡	æè¿°
âœ… æ”¯æŒä»»æ„å»¶è¿Ÿæ—¶é—´	ä¸ä¾èµ– MQ åŸç”Ÿ level å»¶è¿Ÿæœºåˆ¶ï¼Œæ”¯æŒæ¯«ç§’çº§ç²¾åº¦
âœ… å…¼å®¹å¤šç§ MQ	RocketMQ / RabbitMQ / Kafka / ActiveMQ ç­‰
âœ… é«˜å¯ç”¨	å³ä½¿æœåŠ¡é‡å¯ä¹Ÿä¸ä¸¢å¤±å»¶è¿Ÿæ¶ˆæ¯
âœ… åˆ†å¸ƒå¼éƒ¨ç½²	æ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œé¿å…å•ç‚¹æ•…éšœ
âœ… æ€§èƒ½ä¼˜åŒ–	å‡å°‘èµ„æºæµªè´¹ï¼Œæ”¯æŒåŠ¨æ€æ‰«æé¢‘ç‡è°ƒæ•´
âœ… æ˜“äºé›†æˆ	æä¾›ç»Ÿä¸€æ¥å£ï¼Œæ–¹ä¾¿æ¥å…¥ä¸šåŠ¡ç³»ç»Ÿ
ğŸ§± æ ¸å¿ƒç»„ä»¶æ¶æ„å›¾
æ·±è‰²ç‰ˆæœ¬
ç”Ÿäº§è€…
   â†“
é€šç”¨å»¶è¿Ÿæ¶ˆæ¯æ¥å£ DelayMessageSender
   â†“
Redis Sorted Set + MySQLï¼ˆåŒå†™ï¼‰
   â†“
å®šæ—¶ä»»åŠ¡ï¼ˆQuartz / ScheduledExecutorServiceï¼‰
   â†“
MQ æ¶ˆæ¯æŠ•é€’å™¨ï¼ˆé€‚é…ä¸åŒ MQï¼‰
   â†“
æ¶ˆè´¹è€…
ğŸ”‘ å…³é”®æŠ€æœ¯é€‰å‹
ç»„ä»¶	æŠ€æœ¯é€‰å‹	è¯´æ˜
æ¶ˆæ¯å­˜å‚¨	Redis ZSet + MySQL	Redis ç”¨äºé«˜æ•ˆæŸ¥è¯¢åˆ°æœŸæ¶ˆæ¯ï¼ŒMySQL ç”¨äºæŒä¹…åŒ–
å®šæ—¶ä»»åŠ¡	Quartz æˆ– ScheduledExecutorService	æ§åˆ¶å®šæ—¶æ‰«æé€»è¾‘
MQ é€‚é…	æ¥å£æŠ½è±¡ + å¤šå®ç°	ä¸ºæ¯ç§ MQ å®ç°ç‹¬ç«‹å‘é€é€»è¾‘
æ¶ˆæ¯ç»“æ„	JSON + å­—èŠ‚æµ	ä¿è¯å…¼å®¹æ€§ä¸çµæ´»æ€§
ğŸ“¦ æ•°æ®æ¨¡å‹è®¾è®¡
DelayMessage å®ä½“ç±»ï¼ˆJava ç¤ºä¾‹ï¼‰
java
æ·±è‰²ç‰ˆæœ¬
public class DelayMessage {
    private String messageId;       // å”¯ä¸€ ID
    private String topic;           // ä¸»é¢˜
    private String tag;             // æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
    private byte[] body;            // æ¶ˆæ¯ä½“
    private Map<String, String> properties; // å±æ€§
    private long deliverTimeMs;     // æŠ•é€’æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
    private String mqType;          // æ¶ˆæ¯é˜Ÿåˆ—ç±»å‹ï¼ˆrocketmq/rabbitmq/kafka ç­‰ï¼‰
}
Redis å­˜å‚¨ç»“æ„ï¼ˆSorted Setï¼‰
bash
æ·±è‰²ç‰ˆæœ¬
ZADD delay_queue <deliverTimeMs> <messageId>
key: delay_queue
value: messageId
score: deliverTimeMsï¼ˆæœŸæœ›æŠ•é€’æ—¶é—´æˆ³ï¼‰
MySQL è¡¨ç»“æ„ç¤ºä¾‹
sql
æ·±è‰²ç‰ˆæœ¬
CREATE TABLE delay_message (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(64) NOT NULL,
    topic VARCHAR(255),
    tag VARCHAR(255),
    body BLOB,
    properties TEXT,
    deliver_time_ms BIGINT,
    status ENUM('PENDING', 'DELIVERED', 'FAILED') DEFAULT 'PENDING',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME ON UPDATE CURRENT_TIMESTAMP
);
â° å®šæ—¶ä»»åŠ¡é€»è¾‘ï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰
åŠŸèƒ½æè¿°ï¼š
å®šæœŸä» Redis ä¸­è·å–æ‰€æœ‰å·²åˆ°æœŸçš„æ¶ˆæ¯ï¼ˆscore <= å½“å‰æ—¶é—´ï¼‰
é€šè¿‡ MQ é€‚é…å™¨å°†æ¶ˆæ¯å‘é€åˆ°å¯¹åº” Broker
æ›´æ–°æ•°æ®åº“çŠ¶æ€ä¸ºâ€œå·²æŠ•é€’â€
ä» Redis ä¸­åˆ é™¤è¯¥æ¶ˆæ¯
Java ç¤ºä¾‹ä»£ç ï¼ˆä¼ªä»£ç ï¼‰
java
æ·±è‰²ç‰ˆæœ¬
public void scanAndDeliver() {
    long now = System.currentTimeMillis();
    Set<String> expiredMessageIds = redis.zrangebyscore("delay_queue", 0, now);

    for (String msgId : expiredMessageIds) {
        DelayMessage message = loadFromDB(msgId);
        if (message == null) continue;

        try {
            MQAdapter adapter = getMQAdapter(message.getMqType());
            adapter.send(message); // å‘é€åˆ°å¯¹åº”çš„ MQ
            markAsDelivered(msgId); // æ ‡è®°ä¸ºå·²æŠ•é€’
            redis.zrem("delay_queue", msgId); // åˆ é™¤ Redis ç¼“å­˜
        } catch (Exception e) {
            log.error("æ¶ˆæ¯æŠ•é€’å¤±è´¥: " + msgId, e);
            markAsFailed(msgId);
        }
    }
}
ğŸ”„ å®šæ—¶ä»»åŠ¡é…ç½®å»ºè®®
é…ç½®é¡¹	å»ºè®®å€¼	è¯´æ˜
åˆå§‹æ‰«æé—´éš”	100ms	å¹³è¡¡æ€§èƒ½ä¸å»¶è¿Ÿç²¾åº¦
æœ€å°é—´éš”	20ms	é€‚ç”¨äºé«˜ç²¾åº¦åœºæ™¯
æœ€å¤§é—´éš”	500ms	é€‚ç”¨äºä½è´Ÿè½½ç¯å¢ƒ
åŠ¨æ€è°ƒèŠ‚	âœ… å¼€å¯	æ ¹æ®æ¶ˆæ¯æ•°é‡è‡ªåŠ¨è°ƒæ•´æ‰«æé¢‘ç‡
ç¤ºä¾‹ï¼šJava ScheduledExecutorService é…ç½®
java
æ·±è‰²ç‰ˆæœ¬
ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
scheduler.scheduleAtFixedRate(this::scanAndDeliver, 0, 100, TimeUnit.MILLISECONDS);
ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
ä¼˜åŒ–é¡¹	æè¿°
âœ… åˆ†ç‰‡	å°† delay_queue æ‹†åˆ†ä¸ºå¤šä¸ª keyï¼ˆå¦‚ delay_queue_0 ~ delay_queue_15ï¼‰ï¼Œå¹¶è¡Œå¤„ç†
âœ… å¼‚æ­¥å¤„ç†	ä½¿ç”¨çº¿ç¨‹æ± å¼‚æ­¥æŠ•é€’æ¶ˆæ¯ï¼Œé˜²æ­¢é˜»å¡å®šæ—¶ä»»åŠ¡
âœ… æ‰¹é‡å¤„ç†	æ¯æ¬¡æ‰«æå–å‡ºä¸€æ‰¹æ¶ˆæ¯å¤„ç†ï¼Œå‡å°‘ Redis è°ƒç”¨æ¬¡æ•°
âœ… åŠ¨æ€é¢‘ç‡	æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´æ‰«æé¢‘ç‡
âœ… æ¶ˆæ¯å»é‡	åˆ©ç”¨ messageId é¿å…é‡å¤æŠ•é€’
âœ… æ•…éšœæ¢å¤	å®šæœŸæ£€æŸ¥æœªæŠ•é€’æ¶ˆæ¯ï¼Œé‡æ–°åŠ å…¥é˜Ÿåˆ—
âœ… ç›‘æ§æŠ¥è­¦	å¯¹é•¿æ—¶é—´æœªæŠ•é€’çš„æ¶ˆæ¯è¿›è¡Œé¢„è­¦
ğŸ”„ MQ é€‚é…å±‚è®¾è®¡
æ¥å£å®šä¹‰ï¼ˆJavaï¼‰
java
æ·±è‰²ç‰ˆæœ¬
public interface MQAdapter {
    void send(DelayMessage message);
}
ç¤ºä¾‹å®ç°ï¼šRocketMQ
java
æ·±è‰²ç‰ˆæœ¬
public class RocketMQAdapter implements MQAdapter {
    private Producer producer;

    public RocketMQAdapter(String topic) {
        this.producer = new DefaultMQProducer("delay_producer_group");
        producer.setNamesrvAddr("localhost:9876");
        producer.start();
    }

    @Override
    public void send(DelayMessage message) {
        Message msg = new Message(message.getTopic(), message.getBody());
        msg.putUserProperty("TIMER_DELIVER_MS", String.valueOf(message.getDeliverTimeMs()));
        producer.send(msg);
    }
}
å…¶ä»– MQ å®ç°ç±»ä¼¼ï¼Œåªéœ€é‡å†™ send() æ–¹æ³•å³å¯ã€‚
ğŸ“¦ ç”Ÿäº§è€… APIï¼ˆç»Ÿä¸€å…¥å£ï¼‰
java
æ·±è‰²ç‰ˆæœ¬
public class DelayMessageSender {

    public static void sendDelayedMessage(DelayMessage message) {
        saveToRedis(message);
        saveToDB(message);
        log.info("å»¶è¿Ÿæ¶ˆæ¯å·²æ³¨å†Œï¼ŒID={}", message.getMessageId());
    }
}